# Reference by https://github.com/milador/XAC-Virtual-Joystick
#!/bin/bash

sleep 2
SWITCHPRO=switch_pro
JOYSTICK=pc_joystick 

# Create joystick gadget
cd /sys/kernel/config/usb_gadget/
mkdir -p ${SWITCHPRO}
cd ${SWITCHPRO}

# Define USB specification
echo 0x057e > idVendor
echo 0x2009 > idProduct
echo 0x0109 > bcdDevice            # v1.0.0
echo 0x0210 > bcdUSB               # USB2
echo 0x00 > bDeviceClass           # USB_CSCP_NoDeviceClass 0x00
echo 0x00 > bDeviceSubClass        # USB_CSCP_NoDeviceSubclass 0x00
echo 0x00 > bDeviceProtocol        # USB_CSCP_NoDeviceProtocol 0x00

# Perform localization
mkdir -p strings/0x409

echo "000000000001" > strings/0x409/serialnumber
echo "Nintendo Co., Ltd." > strings/0x409/manufacturer
echo "Pro Controller" > strings/0x409/product


# Define the functions of the device
mkdir functions/hid.usb0
echo 0 > functions/hid.usb0/protocol
echo 0 > functions/hid.usb0/subclass
echo 3 > functions/hid.usb0/report_length


echo "050115000904a1018530050105091901290a150025017501950a5500650081020509190b290e150025017501950481027501950281030b01000100a1000b300001000b310001000b320001000b35000100150027ffff0000751095048102c00b39000100150025073500463b0165147504950181020509190f2912150025017501950481027508953481030600ff852109017508953f8103858109027508953f8103850109037508953f9183851009047508953f9183858009057508953f9183858209067508953f9183c0" | xxd -r -ps > functions/hid.usb0/report_desc

# Create configuration file
mkdir configs/c.1
mkdir configs/c.1/strings/0x409

echo 0x80 > configs/c.1/bmAttributes
echo 500 > configs/c.1/MaxPower # 200 mA
echo "Switch Pro configuration" > configs/c.1/strings/0x409/configuration

# Link the configuration file
ln -s functions/hid.usb0 configs/c.1

# Define the functions of the device
mkdir functions/hid.usb1
echo 0 > functions/hid.usb1/protocol
echo 0 > functions/hid.usb1/subclass
echo 3 > functions/hid.usb1/report_length

echo "05010904a101a10275089505150026ff00350046ff00093209350930093109008102750495012507463b0165140939814265007501950c2501450105091901290c81020600ff750195082501450109018102c0a1027508950846ff0026ff0009029102750895040902b102c0c0" | xxd -r -ps > functions/hid.usb1/report_desc

# Link the configuration file
ln -s functions/hid.usb1 configs/c.1

# Activate device
ls /sys/class/udc > UDC

sleep 5
